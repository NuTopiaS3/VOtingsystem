
import firebase_admin
from firebase_admin import credentials, initialize_app, db as firebase_db
from kivy.config import Config
from kivymd.app import MDApp
from kivy.lang import Builder
from kivy.uix.screenmanager import Screen,ScreenManager
from kivy.animation import Animation
import os,sys
from kivy.resources import resource_add_path, resource_find
from kivy.core.window import Window
from kivy.uix.floatlayout import FloatLayout
import pyrebase

# Firebase configuration
config = {
    "apiKey": "AIzaSyDy-x6jIFpY-Kb4rsCk1-0SRTwSQlD2R3E",
    "authDomain": "voting-system-gugan.firebaseapp.com",
    "databaseURL": "https://voting-system-gugan-default-rtdb.asia-southeast1.firebasedatabase.app",
    "projectId": "voting-system-gugan",
    "storageBucket": "voting-system-gugan.appspot.com",
    "messagingSenderId": "1044881782390",
    "appId": "1:1044881782390:web:571667c95213fc7a5f9157"
}

# Initialize Firebase app
firebase = pyrebase.initialize_app(config)
db = firebase.database()
storage = firebase.storage()

# Disabling Right Click
Config.set('input', 'mouse', 'mouse,disable_multitouch')

class LoginScreen(Screen):
    pass

class PrefectScreen(Screen):
    pass

class PrefectgScreen(Screen):
    pass

class StudentScreen(Screen):
    pass

class Maplec(Screen):
    pass

class Maplev(Screen):
    pass

class Cedarc(Screen):
    pass

class Cedarv(Screen):
    pass

class Oakc(Screen):
    pass

class Oakv(Screen):
    pass

class Pinec(Screen):
    pass

class Pinev(Screen):
    pass
kv1 = "D:/Gugan/VOtingsystem/main.kv"

class MainApp(MDApp):
    current_admin_house = ''
    current_admin_id = None

    def build(self):
        self.sc = ScreenManager()
        self.sc.add_widget(LoginScreen(name='log'))
        self.sc.add_widget(PrefectScreen(name='votepb'))
        self.sc.add_widget(PrefectgScreen(name='votepg'))
        self.sc.add_widget(StudentScreen(name='votes'))
        self.sc.add_widget(Maplec(name='maplec'))
        self.sc.add_widget(Maplev(name='maplev'))
        self.sc.add_widget(Cedarc(name='cedarc'))
        self.sc.add_widget(Cedarv(name='cedarv'))
        self.sc.add_widget(Oakc(name='oakc'))
        self.sc.add_widget(Oakv(name='oakv'))
        self.sc.add_widget(Pinec(name='pinec'))
        self.sc.add_widget(Pinev(name='pinev'))
        return self.sc

    def on_start(self):
        self.init_vote_functions()

    def init_vote_functions(self):
        categories = [
            ('cedar_captain_cont1', 'cedarv'), ('cedar_captain_cont2', 'cedarv'),
            ('cedar_captain_cont3', 'cedarv'), ('cedar_captain_cont4', 'cedarv'),
            ('cedar_vc_cont1', 'log'), ('cedar_vc_cont2', 'log'),
            ('cedar_vc_cont3', 'log'), ('cedar_vc_cont4', 'log'),
            ('maple_captain_cont1', 'maplev'), ('maple_captain_cont2', 'maplev'),
            ('maple_captain_cont3', 'maplev'), ('maple_captain_cont4', 'maplev'),
            ('maple_vc_cont1', 'log'), ('maple_vc_cont2', 'log'),
            ('maple_vc_cont3', 'log'), ('maple_vc_cont4', 'log'),
            ('oak_captain_cont1', 'oakv'), ('oak_captain_cont2', 'oakv'),
            ('oak_captain_cont3', 'oakv'), ('oak_captain_cont4', 'oakv'),
            ('oak_vc_cont1', 'log'), ('oak_vc_cont2', 'log'),
            ('oak_vc_cont3', 'log'), ('oak_vc_cont4', 'log'),
            ('pine_captain_cont1', 'pinev'), ('pine_captain_cont2', 'pinev'),
            ('pine_captain_cont3', 'pinev'), ('pine_captain_cont4', 'pinev'),
            ('pine_vc_cont1', 'log'), ('pine_vc_cont2', 'log'),
            ('pine_vc_cont3', 'log'), ('pine_vc_cont4', 'log'),
            ('prefect_boy_cont1', 'votepg'), ('prefect_boy_cont2', 'votepg'),
            ('prefect_boy_cont3', 'votepg'), ('prefect_boy_cont4', 'votepg'),
            ('prefect_girl_cont1', 'votes'), ('prefect_girl_cont2', 'votes'),
            ('prefect_girl_cont3', 'votes'), ('prefect_girl_cont4', 'votes'),
            ('student_council_cont1', 'votes'), ('student_council_cont2', 'votes'),
            ('student_council_cont3', 'votes'), ('student_council_cont4', 'votes'),
        ]
        for category, screen in categories:
            # For student council votes, use handle_student_council_vote
            if 'student_council' in category:
                from functools import partial
                cast_vote_for_category = partial(self.handle_student_council_vote, category)
            else:
                from functools import partial
                cast_vote_for_category = partial(self.cast_vote, category)
            
            # Dynamically assign this new method to handle votes for the category
            setattr(self, category, cast_vote_for_category)

    def cast_vote(self, category):
        if self.current_admin_id:
            db.child("result").child(category).child(self.current_admin_id).set(True)
            print(f"Vote recorded for {category} by {self.current_admin_id}")
            if 'student_council' in category:
                next_screen = self.get_next_screen_based_on_house()
                self.sc.current = next_screen
                print("Navigating to next screen after student council vote:", next_screen)
            elif category.startswith('prefect_boy'):
                # If the vote is for boy prefect, move to the next screen
                next_screen = 'prefect_girl_cont1'
                self.sc.current = next_screen
                print("Navigating to next screen after boy prefect vote:", next_screen)
            else:
                print("Vote recorded but no navigation required for this category.")
        else:
            print("User not logged in or ID not set.")
                
    def handle_student_council_vote(self, category):
        self.cast_vote(category)  # Cast the vote
        next_screen = self.get_next_screen_based_on_house()  # Get the next screen based on the user's house
        print("Next screen after student council vote:", next_screen)
        self.sc.current = next_screen  # Navigate to the next screen

    def get_next_screen_based_on_house(self):
        house_to_screen_mapping = {
            'Maple': 'maplec',
            'Cedar': 'cedarc',
            'Oak': 'oakc',
            'Pine': 'pinec',
        }
        house = self.get_current_admin_house()
        print("Current admin house in get_next_screen_based_on_house:", house)
        next_screen = house_to_screen_mapping.get(house, 'log')
        print("Next screen:", next_screen)
        return next_screen
    
    def get_current_admin_house(self):
        current_user = firebase.auth().get_account_info(firebase.auth().current_user['idToken'])
        admin_data = db.child("admins").child(current_user['users'][0]['localId']).get().val() or {}
        return admin_data.get('house', 'Unknown')

    def login(self, user, passw, error):
        # Adjusted login function to store current_admin_id
        admins = db.child("Admin").get().val() or {}
        for admin_id, admin_data in admins.items():
            if admin_data.get("ID") == user.text and admin_data.get("Password") == passw.text:
                if not admin_data.get("Voted", False):
                    self.current_admin_id = admin_id  # Storing the admin ID
                    self.current_admin_house = admin_data["House"]
                    db.child("Admin").child(admin_id).update({"Voted": True})
                    self.sc.current = 'votepb'  # Navigate to the voting page
                    print("Login Successful")
                    return
                else:
                    error.text = "You have already voted."
                    return
        error.text = "Login failed. Please check your credentials."

Window.fullscreen = True
Window.size=(1920,1080)

if __name__ == "__main__":
    try:
        if hasattr(sys, "_MEIPASS"):
            resource_add_path(os.path.join(sys._MEIPASS))
        app = MainApp()
        app.run()
    except Exception as e:
        print(e)
        input("Press enter.")